#------------------------------------------------------------------------------
#! @file eoscp-rain-test
#! @author Elvin-Alin Sindrilaru - CERN
#------------------------------------------------------------------------------

#/************************************************************************
# * EOS - the CERN Disk Storage System                                   *
# * Copyright (C) 2011 CERN/Switzerland                                  *
# *                                                                      *
# * This program is free software: you can redistribute it and/or modify *
# * it under the terms of the GNU General Public License as published by *
# * the Free Software Foundation, either version 3 of the License, or    *
# * (at your option) any later version.                                  *
# *                                                                      *
# * This program is distributed in the hope that it will be useful,      *
# * but WITHOUT ANY WARRANTY; without even the implied warranty of       *
# * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        *
# * GNU General Public License for more details.                         *
# *                                                                      *
# * You should have received a copy of the GNU General Public License    *
# * along with this program.  If not, see <http://www.gnu.org/licenses/>.*
# ************************************************************************/

#------------------------------------------------------------------------------
# Description: The script is used to test the RAIN-like layout using the eoscp
#              command.
# Usage:
# eoscp-rain-test raidDP/reedS root://host//eos_file root://host//eos_plain_dir
# - first argument is the type of RAIN layout to be used
# - second argument is a file in eos which will be transformed from its current
#   layout to a RAIN file 
# - third argument will be a directory in EOS which as a **PLAIN** layout with
#   block level checksum enabled where the stripes will be saved 
#
# The script does the following:
#  - transform the file to a RAIN layout
#  - reconstruct the inital file from the stripes and check using sum to see 
#    if the inital file and the reconstructed on match
#  - disable one by one each of the stripes i.e. use an empty dummy.rain file 
#    and reconstruct the inital file without any recovery of the stripe file
#  - the precvious step but with the recovery of the stripe file. Notice the 
#    "-f" flag passed to the eoscp command. This is also followed by a check
#    of the original file and the reconstructed one but also of the original
#    stripe and the reconstructed one i.e. the dummy.rain file
#
#------------------------------------------------------------------------------

#! /bin/bash

. /etc/init.d/functions

# Create error message
export ERR_MSG1="The provided directory does not have the extended attributes set correctly."

# Set the path to eoscp, eos and others
EOSCP=$(which eoscp)
EOS=$(which eos)
LOGNAME=$(logname)

if [ $LOGNAME != "root" ]; then
  SUDO="sudo"
else 
  SUDO=""
fi


#-------------------------------------------------------------------------------
# Check if two files are identical by computing the sum
# 
# @param first file
# @param second files
#
#-------------------------------------------------------------------------------
function check_identical()
{
  local XRD_PATH1=$1
  local XRD_PATH2=$2 

  # Extract physical file name from EOS using the file info function 
  local INDX=`awk -v a="$XRD_PATH1" -v b="//eos" 'BEGIN{print index(a,b)}'`
  local EOS_FILE1="${XRD_PATH1:$INDX}"

  local INDX=`awk -v a="$XRD_PATH2" -v b="//eos" 'BEGIN{print index(a,b)}'`
  local EOS_FILE2="${XRD_PATH1:$INDX}"

  local PFN1=`$SUDO $EOS file info $EOS_FILE1 --fullpath | grep "online" | sed 's/^.* //'`
  local PFN2=`$SUDO $EOS file info $EOS_FILE2 --fullpath | grep "online" | sed 's/^.* //'`
   
  local XS1=$(sum $PFN1)
  local XS2=$(sum $PFN2)

  test "$XS1" = "$XS2"
  if [[ $? -eq 0 ]]; then
    echo_success
  else 
    echo_failure
    exit 1
  fi
}


#-------------------------------------------------------------------------------
# Main part
#-------------------------------------------------------------------------------

if [[ $# -eq 0 || $# -ne 3 ]]; 
then 
    echo usage: $0 raidDP/reedS root://host//eos_file root://host//eos_plain_dir
    exit 1
fi

# The layout type can be either raidDP or reedS
LAYOUT=$1

if [[ "$LAYOUT" != "raidDP" && "$LAYOUT" != "reedS" ]]; then
    echo "No such layout for RAIN" 
    echo usage: $0 root://host//eos_file root://host//eos_plain_dir raidDP/reedS
    exit 1
fi

# Source file to be converted to a RAIN layout
EOS_SRC=$2

# Location where the RAIN files will be saved, note that this needs to be a 
# plain layout directory
EOS_DST=$3

# Extract the EOS destination directory name
INDX=`awk -v a="$EOS_DST" -v b="//eos" 'BEGIN{print index(a,b)}'`
EOS_DST_DIR="${EOS_DST:$INDX}"

$SUDO $EOS -b attr ls "$EOS_DST_DIR" | grep -q 'sys.forced.layout="plain"'
if [ $? -ne 0 ]; then
    echo "$ERR_MSG1"
    echo_failure
    exit 1
fi

echo "Convert the file to a RAIN layout ..." 
$EOSCP -e raidDP -S 1 -D 6 -P 2 $EOS_SRC \
    $EOS_DST/stripe1.rain \
    $EOS_DST/stripe2.rain \
    $EOS_DST/stripe3.rain \
    $EOS_DST/stripe4.rain \
    $EOS_DST/stripe5.rain \
    $EOS_DST/stripe6.rain


echo "Rebuild the file from the new stripes ..." 
$EOSCP -e $LAYOUT -S 6 -D 1 -P 2  \
    $EOS_DST/stripe1.rain \
    $EOS_DST/stripe2.rain \
    $EOS_DST/stripe3.rain \
    $EOS_DST/stripe4.rain \
    $EOS_DST/stripe5.rain \
    $EOS_DST/stripe6.rain \
    $EOS_DST/result.rain  


echo "Check if files are identical"
check_identical $EOS_SRC $EOS_DST/result.rain

echo "Delete the file stripes one by one and reconstruct the file"
#VECT_STRIPES=(1, 2, 3, 4, 5, 6)
ALL_STRIPES=( 1 2 3 4 5 6 )
VECT_STRIPES=( 1 2 3 4 5 6 )

for i in "${VECT_STRIPES[@]}"; do
    FILE_NAMES=()
    
    for j in "${ALL_STRIPES[@]}"; do
       if [ "$i" == "$j" ]; then 
       	  FILE_NAMES+=("$EOS_DST/dummy.rain")    
       else 
          FILE_NAMES+=("$EOS_DST/stripe$j.rain")
       fi
    done

    echo ${FILE_NAMES[*]}

    $SUDO $EOS -b rm "$EOS_DST_DIR/result.rain"
    
    echo "Do on-the-fly recovery ..."
    $EOSCP -e $LAYOUT -S 6 -D 1 -P 2  \
    ${FILE_NAMES[0]} \
    ${FILE_NAMES[1]} \
    ${FILE_NAMES[2]} \
    ${FILE_NAMES[3]} \
    ${FILE_NAMES[4]} \
    ${FILE_NAMES[5]} \
    $EOS_DST/result.rain  

    echo "Check if result files are identical"
    check_identical $EOS_SRC $EOS_DST/result.rain
    
    echo "Recover also the missing stripe..."
    $EOSCP -f -e $LAYOUT -S 6 -D 1 -P 2  \
    ${FILE_NAMES[0]} \
    ${FILE_NAMES[1]} \
    ${FILE_NAMES[2]} \
    ${FILE_NAMES[3]} \
    ${FILE_NAMES[4]} \
    ${FILE_NAMES[5]} \
    $EOS_DST/result.rain  
    
    echo "Check if recovered stripes are identical"
    check_identical $EOS_DST/stripe$i.rain $EOS_DST/dummy.rain

    $SUDO $EOS -b rm "$EOS_DST_DIR/dummy.rain"       
    unset "FILE_NAMES"

done


# Clean up
$SUDO $EOS -b rm "$EOS_DST_DIR/stripe1.rain"
$SUDO $EOS -b rm "$EOS_DST_DIR/stripe2.rain"
$SUDO $EOS -b rm "$EOS_DST_DIR/stripe3.rain"
$SUDO $EOS -b rm "$EOS_DST_DIR/stripe4.rain"
$SUDO $EOS -b rm "$EOS_DST_DIR/stripe5.rain"
$SUDO $EOS -b rm "$EOS_DST_DIR/stripe6.rain"
$SUDO $EOS -b rm "$EOS_DST_DIR/result.rain"

exit 0

    







